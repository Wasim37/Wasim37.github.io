"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("inferno"),t=require("stream"),r="a runtime error occured! Use Inferno in development environment to find the error.",n=Array.isArray;function o(e){var t=typeof e;return"string"===t||"number"===t}function i(e){return void 0===e||null===e}function s(e){return null===e||!1===e||!0===e||void 0===e}function u(e){return"function"===typeof e}function a(e){return"string"===typeof e}function l(e){return"number"===typeof e}function c(e){return null===e}function d(e){return void 0===e}function h(e){throw e||(e=r),new Error("Inferno Error: "+e)}function f(e,t){var r={};if(e)for(var n in e)r[n]=e[n];if(t)for(var o in t)r[o]=t[o];return r}function p(e){if(a(e))return e;var t="";for(var r in e){var n=e[r];o(n)&&(t+=r+":"+n+";")}return t}var v=new RegExp(/["'&<>]/);function m(e){if(!v.test(e))return e;var t,r="",n="",o=0;for(t=0;t<e.length;++t){switch(e.charCodeAt(t)){case 34:n="&quot;";break;case 39:n="&#039;";break;case 38:n="&amp;";break;case 60:n="&lt;";break;case 62:n="&gt;";break;default:continue}t>o&&(r+=e.slice(o,t)),r+=n,o=t+1}return r+e.slice(o,t)}var g=":A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",y=g+"\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040",x=new RegExp("^["+g+"]["+y+"]*$"),T={},Q={};function S(e){if(void 0!==Q[e])return!0;if(void 0!==T[e])return!1;if(x.test(e))return Q[e]=!0,!0;return T[e]=!0,!1}var k=new Set(["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"]);function F(e,t,r){if(e.constructor.getDerivedStateFromProps)return f(r,e.constructor.getDerivedStateFromProps(t,r));return r}function b(t,r,o){var d=t.flags,v=t.type,g=t.props||e.EMPTY_OBJ,y=t.children;if(0!==(14&d)){if(4&d){var x,T=new v(g,o),Q=Boolean(v.getDerivedStateFromProps);if(T.$BS=!1,T.$SSR=!0,u(T.getChildContext)&&(x=T.getChildContext()),x=i(x)?o:f(o,x),T.props===e.EMPTY_OBJ&&(T.props=g),T.context=o,!Q&&u(T.componentWillMount)){T.$BR=!0,T.componentWillMount(),T.$BR=!1;var P=T.$PS;if(P){var C=T.state;if(null===C)T.state=P;else for(var N in P)C[N]=P[N];T.$PSS=!1,T.$PS=null}}Q&&(T.state=F(T,g,T.state));var _=T.render(g,T.state,T.context);if(s(_))return"\x3c!--!--\x3e";if(a(_))return m(_);if(l(_))return _+"";return b(_,t,x)}var $=v(g,o);if(s($))return"\x3c!--!--\x3e";if(a($))return m($);if(l($))return $+"";return b($,t,o)}if(0!==(481&d)){var w,B="<"+v,M=k.has(v),R=t.className;if(a(R)?B+=' class="'+m(R)+'"':l(R)&&(B+=' class="'+R+'"'),!c(g)){for(var D in g){var E=g[D];switch(D){case"dangerouslySetInnerHTML":w=E.__html;break;case"style":i(g.style)||(B+=' style="'+p(g.style)+'"');break;case"children":case"className":break;case"defaultValue":g.value||(B+=' value="'+(a(E)?m(E):E)+'"');break;case"defaultChecked":g.checked||(B+=' checked="'+E+'"');break;default:S(D)&&(a(E)?B+=" "+D+'="'+m(E)+'"':l(E)?B+=" "+D+'="'+E+'"':!0===E&&(B+=" "+D))}}"option"===v&&"undefined"!==typeof g.value&&g.value===r.props.value&&(B+=" selected")}if(M)B+=">";else{B+=">";var V=t.childFlags;if(2===V)B+=b(y,t,o);else if(12&V)for(var A=0,O=y.length;A<O;++A)B+=b(y[A],t,o);else 16===V?B+=""===y?" ":m(y):w&&(B+=w);M||(B+="</"+v+">")}if(String(v).match(/[\s\n\/='"\0<>]/))throw B;return B}if(0!==(16&d))return""===y?" ":m(y);if(n(t)||0!==(8192&d)){var I=t.childFlags;if(2===I||n(t)&&0===t.length)return"\x3c!--!--\x3e";if(12&I||n(t)){for(var W=n(t)?t:y,j="",J=0,Y=W.length;J<Y;++J)j+=b(W[J],t,o);return j}}else h();return""}function P(e){return b(e,{},{})}var C=function(t){function r(e){t.call(this),this.collector=[1/0],this.promises=[],this.pushQueue=this.pushQueue.bind(this),e&&this.renderVNodeToQueue(e,null,null)}return t&&(r.__proto__=t),r.prototype=Object.create(t&&t.prototype),r.prototype.constructor=r,r.prototype._read=function(){setTimeout(this.pushQueue,0)},r.prototype.addToQueue=function(e,t){if(i(t))"string"===typeof e&&this.collector.length-1===0?this.push(e):"string"===typeof e&&"string"===typeof this.collector[this.collector.length-2]?this.collector[this.collector.length-2]+=e:this.collector.splice(-1,0,e);else{var r=this.promises[t].length-1;"string"===typeof this.promises[t][r]&&"string"===typeof e?this.promises[t][r]+=e:this.promises[t].push(e)}},r.prototype.pushQueue=function(){var e=this.collector[0];if("string"===typeof e)this.push(e),this.collector.shift();else if(e&&("object"===typeof e||u(e))&&u(e.then)){var t=this;e.then((function(e){var r;(r=t.collector).splice.apply(r,[0,1].concat(t.promises[e])),t.promises[e]=null,setTimeout(t.pushQueue,0)})),this.collector[0]=null}else e===1/0&&this.emit("end")},r.prototype.renderVNodeToQueue=function(t,r,o){var v=this,g=t.flags,y=t.type,x=t.props||e.EMPTY_OBJ,T=t.children;if((14&g)>0)if(4&g){var Q,b=new y(x,r),P=Boolean(y.getDerivedStateFromProps);if(b.$BS=!1,b.$SSR=!0,d(b.getChildContext)||(Q=b.getChildContext()),i(Q)||(r=f(r,Q)),b.props===e.EMPTY_OBJ&&(b.props=x),b.context=r,!P&&u(b.componentWillMount)){b.$BR=!0,b.componentWillMount();var C=b.$PS;if(C){var N=b.state;if(null===N)b.state=C;else for(var _ in C)N[_]=C[_];b.$PS=null}b.$BR=!1}if(u(b.getInitialProps)){var $=b.getInitialProps(b.props,b.context);if($){if(Promise.resolve($)===$){var w=this.promises.push([])-1;return void this.addToQueue($.then((function(e){"object"===typeof e&&(b.props=f(b.props,e));var t=b.render(b.props,b.state,b.context);return s(t)?v.addToQueue("\x3c!--!--\x3e",w):a(t)?v.addToQueue(m(t),w):l(t)?v.addToQueue(t+"",w):v.renderVNodeToQueue(t,b.context,w),setTimeout(v.pushQueue,0),w})),o)}b.props=f(b.props,$)}}P&&(b.state=F(b,x,b.state));var B=b.render(b.props,b.state,b.context);s(B)?this.addToQueue("\x3c!--!--\x3e",o):a(B)?this.addToQueue(m(B),o):l(B)?this.addToQueue(B+"",o):this.renderVNodeToQueue(B,r,o)}else{var M=y(x,r);s(M)?this.addToQueue("\x3c!--!--\x3e",o):a(M)?this.addToQueue(m(M),o):l(M)?this.addToQueue(M+"",o):this.renderVNodeToQueue(M,r,o)}else if((481&g)>0){var R,D="<"+y,E=k.has(y),V=t.className;if(a(V)?D+=' class="'+m(V)+'"':l(V)&&(D+=' class="'+V+'"'),!c(x))for(var A in x){var O=x[A];switch(A){case"dangerouslySetInnerHTML":R=O.__html;break;case"style":i(x.style)||(D+=' style="'+p(x.style)+'"');break;case"children":case"className":break;case"defaultValue":x.value||(D+=' value="'+(a(O)?m(O):O)+'"');break;case"defaultChecked":x.checked||(D+=' checked="'+O+'"');break;default:S(A)&&(a(O)?D+=" "+A+'="'+m(O)+'"':l(O)?D+=" "+A+'="'+O+'"':!0===O&&(D+=" "+A))}}if(D+=">",String(y).match(/[\s\n\/='"\0<>]/))throw D;if(E)this.addToQueue(D,o);else{var I=t.childFlags;if(2===I)return this.addToQueue(D,o),this.renderVNodeToQueue(T,r,o),void this.addToQueue("</"+y+">",o);if(16===I)return this.addToQueue(D,o),this.addToQueue(""===T?" ":m(T+""),o),void this.addToQueue("</"+y+">",o);if(12&I){this.addToQueue(D,o);for(var W=0,j=T.length;W<j;++W)this.renderVNodeToQueue(T[W],r,o);return void this.addToQueue("</"+y+">",o)}if(R)return void this.addToQueue(D+R+"</"+y+">",o);E||this.addToQueue(D+"</"+y+">",o)}}else if((16&g)>0)this.addToQueue(""===T?" ":m(T),o);else if(n(t)||0!==(8192&g)){var J=t.childFlags;if(2===J||n(t)&&0===t.length)this.addToQueue("\x3c!--!--\x3e",o);else if(12&J||n(t)){for(var Y=n(t)?t:t.children,q=0,H=Y.length;q<H;++q)this.renderVNodeToQueue(Y[q],r,o);return}}else h()},r}(t.Readable);function N(e){return new C(e)}var _=Promise.resolve(),$=function(e){function t(t){e.call(this),this.started=!1,this.initNode=t}return e&&(t.__proto__=e),t.prototype=Object.create(e&&e.prototype),t.prototype.constructor=t,t.prototype._read=function(){var e=this;if(this.started)return;this.started=!0,_.then((function(){return e.renderNode(e.initNode,null)})).then((function(){e.push(null)})).catch((function(t){e.emit("error",t)}))},t.prototype.renderNode=function(e,t){var r=e.flags;if((14&r)>0)return this.renderComponent(e,t,4&r);if((481&r)>0)return this.renderElement(e,t);if(n(e)||0!==(8192&r))return this.renderArrayOrFragment(e,t);return this.renderText(e)},t.prototype.renderArrayOrFragment=function(e,t){var r=this,o=e.childFlags;if(2===o||n(e)&&0===e.length)return this.push("\x3c!--!--\x3e");if(12&o||n(e))return(n(e)?e:e.children).reduce((function(e,n){return e.then((function(){return Promise.resolve(r.renderNode(n,t)).then((function(){return!!(16&n.flags)}))}))}),Promise.resolve(!1))},t.prototype.renderComponent=function(e,t,r){var n=this,o=e.type,c=e.props;if(!r){var d=o(c,t);if(s(d))return this.push("\x3c!--!--\x3e");if(a(d))return this.push(m(d));if(l(d))return this.push(d+"");return this.renderNode(d,t)}var h,p=new o(c,t),v=Boolean(o.getDerivedStateFromProps);return p.$BS=!1,p.$SSR=!0,u(p.getChildContext)&&(h=p.getChildContext()),i(h)||(t=f(t,h)),p.context=t,p.$BR=!0,Promise.resolve(!v&&p.componentWillMount&&p.componentWillMount()).then((function(){var e=p.$PS;if(e){var r=p.state;if(null===r)p.state=e;else for(var o in e)r[o]=e[o];p.$PS=null}p.$BR=!1,v&&(p.state=F(p,c,p.state));var i=p.render(p.props,p.state,p.context);if(s(i))return n.push("\x3c!--!--\x3e");if(a(i))return n.push(m(i));if(l(i))return n.push(i+"");return n.renderNode(i,t)}))},t.prototype.renderChildren=function(e,t,r){var n=this;if(2===r)return this.renderNode(e,t);if(16===r)return this.push(""===e?" ":m(e+""));if(12&r)return e.reduce((function(e,r){return e.then((function(){return Promise.resolve(n.renderNode(r,t)).then((function(){return!!(16&r.flags)}))}))}),Promise.resolve(!1))},t.prototype.renderText=function(e){this.push(""===e.children?" ":m(e.children))},t.prototype.renderElement=function(e,t){var r,n=this,o=e.type,s=e.props,u="<"+o,d=k.has(o),h=e.className;if(a(h)?u+=' class="'+m(h)+'"':l(h)&&(u+=' class="'+h+'"'),!c(s))for(var f in s){var v=s[f];switch(f){case"dangerouslySetInnerHTML":r=v.__html;break;case"style":i(s.style)||(u+=' style="'+p(s.style)+'"');break;case"children":case"className":break;case"defaultValue":s.value||(u+=' value="'+(a(v)?m(v):v)+'"');break;case"defaultChecked":s.checked||(u+=' checked="'+v+'"');break;default:if(S(f)){a(v)?u+=" "+f+'="'+m(v)+'"':l(v)?u+=" "+f+'="'+v+'"':!0===v&&(u+=" "+f);break}}}if(u+=">",this.push(u),String(o).match(/[\s\n\/='"\0<>]/))throw u;if(d)return;if(r)return this.push(r),void this.push("</"+o+">");var g=e.childFlags;if(1===g)return void this.push("</"+o+">");return Promise.resolve(this.renderChildren(e.children,t,g)).then((function(){n.push("</"+o+">")}))},t}(t.Readable);function w(e){return new $(e)}exports.RenderQueueStream=C,exports.RenderStream=$,exports.renderToStaticMarkup=P,exports.renderToString=P,exports.streamAsStaticMarkup=w,exports.streamAsString=w,exports.streamQueueAsStaticMarkup=N,exports.streamQueueAsString=N;
